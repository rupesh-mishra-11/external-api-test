<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Runner - External API Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        /* Environment-specific colors */
        .controls.env-dev {
            background: #508611;
        }

        .controls.env-prod {
            background: #d50009;
        }

        .controls.env-dev .btn-primary,
        .controls.env-prod .btn-primary {
            background: white;
            color: #333;
        }

        .controls.env-dev .btn-primary:hover,
        .controls.env-prod .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .controls.env-dev label,
        .controls.env-prod label {
            color: white !important;
        }

        .controls.env-dev .btn-secondary,
        .controls.env-prod .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .controls.env-dev .btn-secondary:hover,
        .controls.env-prod .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .controls.env-dev .filter-btn,
        .controls.env-prod .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .controls.env-dev .filter-btn.active,
        .controls.env-prod .filter-btn.active {
            background: white;
            color: #333;
            border: 1px solid white;
        }

        .controls.env-dev .filter-btn:hover,
        .controls.env-prod .filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .controls.env-dev .filter-btn.active:hover,
        .controls.env-prod .filter-btn.active:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .summary-card .number {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-card .label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card.total .number { color: #667eea; }
        .summary-card.passed .number { color: #10b981; }
        .summary-card.failed .number { color: #ef4444; }
        .summary-card.time .number { font-size: 32px; }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        .test-card.running {
            border-left-color: #f59e0b;
            animation: pulse 2s ease-in-out infinite;
        }

        .test-card.passed {
            border-left-color: #10b981;
        }

        .test-card.failed {
            border-left-color: #ef4444;
        }

        .test-card.blocked {
            border-left-color: #d50009;
            background: #fff5f5;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .test-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .test-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-post { background: #dbeafe; color: #1e40af; }
        .badge-get { background: #d1fae5; color: #065f46; }
        .badge-put { background: #fef3c7; color: #92400e; }
        .badge-delete { background: #fee2e2; color: #991b1b; }

        .test-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }

        .test-category {
            display: inline-block;
            padding: 4px 10px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 12px;
            color: #4b5563;
        }

        .test-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .test-status.pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        .test-status.running {
            background: #fef3c7;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status.passed {
            background: #d1fae5;
            color: #065f46;
        }

        .test-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .test-status.blocked {
            background: #ffe5e5;
            color: #d50009;
            font-weight: 700;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #92400e;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .test-details {
            margin-top: 5px;
            padding: 0px 0px 20px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .test-details.show {
            max-height: 500px;
            overflow-y: auto;
        }

        .test-details pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 11px;
        }

        .toggle-details {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            padding: 5px 0;
        }

        .toggle-details:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .no-tests {
            background: white;
            padding: 60px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .no-tests h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        .response-time {
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ API Test Runner</h1>
            <p>External API Testing Suite - Run individual tests or execute all tests at once</p>
        </div>

        <div class="controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <select id="envSelector" onchange="changeEnvironment()" style="padding: 10px 20px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; min-width: 250px;">
                    <option value="">Loading...</option>
                </select>
                <span id="envTypeBadge" style="padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: none;"></span>
            </div>
            
            <button class="btn btn-primary" onclick="runAllTests()" id="runAllBtn">
                ‚ñ∂ Run All Tests
            </button>
            <button class="btn btn-primary" onclick="clearResults()" id="clearBtn">
                üóëÔ∏è Clear
            </button>
            <button class="btn btn-primary" onclick="loadTestCases()">
                üîÑ Reload Tests
            </button>
            <button class="btn btn-primary" onclick="downloadReport()" id="downloadBtn">
                üì• Download
            </button>
            
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="filterTests('all')">All</button>
                <button class="filter-btn" data-filter="Payment" onclick="filterTests('Payment')">Payment</button>
                <button class="filter-btn" data-filter="Payment Account" onclick="filterTests('Payment Account')">Payment Account</button>
                <button class="filter-btn" data-filter="Auto Payment" onclick="filterTests('Auto Payment')">Auto Payment</button>
                <button class="filter-btn" data-filter="Settings" onclick="filterTests('Settings')">Settings</button>
            </div>
        </div>

        <div class="summary">
            <div class="summary-card total">
                <div class="number" id="totalTests">0</div>
                <div class="label">Total Tests</div>
            </div>
            <div class="summary-card passed">
                <div class="number" id="passedTests">0</div>
                <div class="label">Passed</div>
            </div>
            <div class="summary-card failed">
                <div class="number" id="failedTests">0</div>
                <div class="label">Failed</div>
            </div>
            <div class="summary-card blocked" id="blockedSummaryCard" style="display: none;">
                <div class="number" id="blockedTests">0</div>
                <div class="label">üî¥ Blocked</div>
            </div>
            <div class="summary-card time">
                <div class="number" id="avgTime">0ms</div>
                <div class="label">Avg Response Time</div>
            </div>
        </div>

        <div class="loading" id="loading">Loading test cases...</div>
        
        <div class="test-grid" id="testGrid" style="display: none;"></div>
    </div>

    <script>
        let testCases = [];
        let testResults = {};
        let currentFilter = 'all';
        let environments = [];
        let currentEnvironment = 'capricorn-trunk';

        async function loadEnvironments() {
            try {
                const response = await fetch('/api/environments');
                const data = await response.json();
                
                environments = data.environments;
                currentEnvironment = data.default_environment;
                
                // Populate environment selector
                const selector = document.getElementById('envSelector');
                selector.innerHTML = '';
                
                environments.forEach(env => {
                    const option = document.createElement('option');
                    option.value = env.id;
                    option.textContent = `${env.name}`;
                    if (env.id === currentEnvironment) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                
                // Set initial environment color
                updateEnvironmentColor();
                
                // Load test cases for default environment
                await loadTestCases();
            } catch (error) {
                console.error('Error loading environments:', error);
                document.getElementById('loading').textContent = 'Error loading environments: ' + error.message;
            }
        }

        async function changeEnvironment() {
            const selector = document.getElementById('envSelector');
            currentEnvironment = selector.value;
            
            // Update controls div color based on environment
            updateEnvironmentColor();
            
            // Clear results when switching environments
            testResults = {};
            updateSummary();
            
            // Reload test cases for new environment
            await loadTestCases();
        }

        function updateEnvironmentColor() {
            const controlsDiv = document.querySelector('.controls');
            const badge = document.getElementById('envTypeBadge');
            
            // Define environment colors
            const prodEnvironments = ['rapid-prod', 'standard-prod'];
            const devEnvironments = ['capricorn-trunk', 'rapid-stage', 'standard-stage', 'external-local'];
            
            // Remove existing environment classes
            controlsDiv.classList.remove('env-dev', 'env-prod');
            
            // Add appropriate class based on current environment
            if (prodEnvironments.includes(currentEnvironment)) {
                controlsDiv.classList.add('env-prod');
                badge.textContent = 'üî¥ PRODUCTION';
                badge.style.background = 'rgba(255, 255, 255, 0.3)';
                badge.style.color = 'white';
                badge.style.border = '2px solid white';
                badge.style.display = 'inline-block';
            } else if (devEnvironments.includes(currentEnvironment)) {
                controlsDiv.classList.add('env-dev');
                const envName = currentEnvironment.includes('stage') ? 'STAGING' : 'DEVELOPMENT';
                badge.textContent = 'üü¢ ' + envName;
                badge.style.background = 'rgba(255, 255, 255, 0.3)';
                badge.style.color = 'white';
                badge.style.border = '2px solid white';
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        async function loadTestCases() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('testGrid').style.display = 'none';
                
                const response = await fetch(`/api/test-cases?environment=${currentEnvironment}`);
                const data = await response.json();
                
                testCases = data.test_cases;
                testResults = {};
                
                document.getElementById('totalTests').textContent = testCases.length;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('testGrid').style.display = 'grid';
                
                renderTests();
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading tests: ' + error.message;
            }
        }

        function renderTests() {
            const grid = document.getElementById('testGrid');
            grid.innerHTML = '';
            
            const filtered = currentFilter === 'all' 
                ? testCases 
                : testCases.filter(tc => tc.category === currentFilter);
            
            filtered.forEach(testCase => {
                const card = createTestCard(testCase);
                grid.appendChild(card);
            });
        }

        function createTestCard(testCase) {
            const card = document.createElement('div');
            card.className = 'test-card';
            card.id = `test-${testCase.id}`;
            
            const methodClass = `badge-${testCase.method.toLowerCase()}`;
            
            // Build request bodies display - unified format for both single and multiple
            let bodiesDisplay = '';
            const hasMultipleBodies = testCase.bodies && Array.isArray(testCase.bodies) && testCase.bodies.length > 0;
            
            if (hasMultipleBodies) {
                testCase.bodies.forEach((bodyConfig, idx) => {
                    const scenarioName = bodyConfig.name || `Scenario ${idx + 1}`;
                    const body = bodyConfig.body || bodyConfig;
                    bodiesDisplay += `<div style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #667eea;">
                        <strong>${scenarioName}:</strong>
                        <pre style="margin-top: 5px;">${JSON.stringify(body, null, 2)}</pre>
                    </div>`;
                });
            } else {
                // Single body - display as Scenario 1 for consistency
                bodiesDisplay = `<div style="margin-bottom: 15px; padding: 10px; background: #f9fafb; border-radius: 6px; border-left: 3px solid #667eea;">
                    <strong>Scenario 1:</strong>
                    <pre style="margin-top: 5px;">${JSON.stringify(testCase.body || {}, null, 2)}</pre>
                </div>`;
            }
            
            // Check if this is a Delete Payment Account test case
            const isDeletePaymentAccount = testCase.name && testCase.name.toLowerCase().includes('delete payment account');
            const paymentAccountIdsInput = isDeletePaymentAccount ? `
                <div style="margin-top: 10px; margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px;">
                        Payment Account IDs (comma-separated):
                    </label>
                    <input 
                        type="text" 
                        id="payment-account-ids-${testCase.id}" 
                        placeholder="e.g., 1334083, 1334084, 1334085"
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: monospace;"
                    />
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default ID from test case
                    </small>
                </div>
            ` : '';
            
            // Check if this is a Delete Auto Payment test case
            const isDeleteAutoPayment = testCase.name && testCase.name.toLowerCase().includes('delete auto payment');
            const scheduledPaymentIdsInput = isDeleteAutoPayment ? `
                <div style="margin-top: 10px; margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px;">
                        Scheduled Payment IDs (comma-separated):
                    </label>
                    <input 
                        type="text" 
                        id="scheduled-payment-ids-${testCase.id}" 
                        placeholder="e.g., 263866, 263867, 263868"
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: monospace;"
                    />
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default ID from test case
                    </small>
                </div>
            ` : '';
            
            // Check if this is an Add Auto Payment test case
            const isAddAutoPayment = testCase.name && testCase.name.toLowerCase().includes('add auto payment');
            const addAutoPaymentInputs = isAddAutoPayment ? `
                <div style="margin-top: 10px; margin-bottom: 10px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        Auto Payment Configuration:
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="display: block; font-size: 11px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">
                                Payment Account ID:
                            </label>
                            <input 
                                type="text" 
                                id="auto-payment-account-id-${testCase.id}" 
                                placeholder="e.g., 1329007"
                                style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; font-family: monospace;"
                            />
                        </div>
                        <div>
                            <label style="display: block; font-size: 11px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">
                                Payment Type ID:
                            </label>
                            <input 
                                type="text" 
                                id="auto-payment-type-id-${testCase.id}" 
                                placeholder="e.g., 4"
                                style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; font-family: monospace;"
                            />
                        </div>
                    </div>
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default values. Dates will be auto-calculated (start: next month 1st, end: 2 months later 1st)
                    </small>
                </div>
            ` : '';
            
            // Check if this is a Make Payment test case
            const isMakePayment = testCase.name && testCase.name.toLowerCase().includes('make payment');
            const makePaymentInputs = isMakePayment ? `
                <div style="margin-top: 10px; margin-bottom: 10px; padding: 12px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        Payment Configuration:
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="display: block; font-size: 11px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">
                                Customer Payment Account ID:
                            </label>
                            <input 
                                type="text" 
                                id="make-payment-account-id-${testCase.id}" 
                                placeholder="e.g., 1334096"
                                style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; font-family: monospace;"
                            />
                        </div>
                        <div>
                            <label style="display: block; font-size: 11px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">
                                Payment Type ID:
                            </label>
                            <input 
                                type="text" 
                                id="make-payment-type-id-${testCase.id}" 
                                placeholder="e.g., 7"
                                style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; font-family: monospace;"
                            />
                        </div>
                    </div>
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default values from test case
                    </small>
                </div>
            ` : '';
            
            // Check if this is a Cancel Payment test case
            const isCancelPayment = testCase.name && testCase.name.toLowerCase().includes('cancel payment');
            const cancelPaymentInputs = isCancelPayment ? `
                <div style="margin-top: 10px; margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px;">
                        Payment IDs (comma-separated):
                    </label>
                    <input 
                        type="text" 
                        id="cancel-payment-ids-${testCase.id}" 
                        placeholder="e.g., 1575833457, 1575833458, 1575833459"
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: monospace;"
                    />
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default ID from test case
                    </small>
                </div>
            ` : '';
            
            // Check if this is a Get Payment Receipt or Download Receipt test case
            const isGetPaymentReceipt = testCase.name && (testCase.name.toLowerCase().includes('get payment receipt') || testCase.name.toLowerCase().includes('download receipt'));
            const getPaymentReceiptInputs = isGetPaymentReceipt ? `
                <div style="margin-top: 10px; margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px;">
                        Payment IDs (string):
                    </label>
                    <input 
                        type="text" 
                        id="receipt-payment-ids-${testCase.id}" 
                        placeholder="e.g., 1575816881"
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: monospace;"
                    />
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default ID from test case
                    </small>
                </div>
            ` : '';
            
            // Check if this is a Get Payment Status test case
            const isGetPaymentStatus = testCase.name && testCase.name.toLowerCase().includes('get payment status');
            const getPaymentStatusInputs = isGetPaymentStatus ? `
                <div style="margin-top: 10px; margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 5px;">
                        Payment ID:
                    </label>
                    <input 
                        type="text" 
                        id="payment-status-id-${testCase.id}" 
                        placeholder="e.g., 1575716428"
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: monospace;"
                    />
                    <small style="display: block; margin-top: 4px; color: #6b7280; font-size: 11px;">
                        Leave empty to use default ID from test case
                    </small>
                </div>
            ` : '';
            
            card.innerHTML = `
                <div class="test-header">
                    <div class="test-title">${testCase.name}</div>
                    <span class="test-badge ${methodClass}">${testCase.method}</span>
                </div>
                <div class="test-meta">
                    <span class="test-category">${testCase.category}</span>
                </div>
                <div class="test-status pending" id="status-${testCase.id}">
                    Ready to run
                </div>
                ${paymentAccountIdsInput}
                ${scheduledPaymentIdsInput}
                ${addAutoPaymentInputs}
                ${makePaymentInputs}
                ${cancelPaymentInputs}
                ${getPaymentReceiptInputs}
                ${getPaymentStatusInputs}
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="runSingleTest('${testCase.id}')">
                    ‚ñ∂ Run Test
                </button>
                <button class="toggle-details" onclick="toggleDetails('${testCase.id}')">Show Details</button>
                <div class="test-details" id="details-${testCase.id}">
                    <strong>Endpoint:</strong> ${testCase.endpoint}<br>
                    <strong>Request Bodies:</strong>
                    ${bodiesDisplay}
                    <div id="response-${testCase.id}"></div>
                </div>
            `;
            
            return card;
        }

        function renderSingleResult(result, responseDiv) {
            const requestBodyHtml = result.request_body ? `
                <strong style="display: block; margin-top: 10px;">Request Body:</strong>
                <pre style="margin-top: 5px; background: white; padding: 10px; border-radius: 4px; font-size: 11px;">${JSON.stringify(result.request_body, null, 2)}</pre>
            ` : '';
            
            // Check if this is a Get Payment Receipt response with binary data
            const isReceiptResponse = result.test_name && (
                result.test_name.toLowerCase().includes('get payment receipt') || 
                result.test_name.toLowerCase().includes('download receipt')
            );
            const isBinaryResponse = result.response_data_type === 'binary' || 
                (result.content_type && (result.content_type.includes('pdf') || result.content_type.includes('zip') || result.content_type.includes('octet-stream')));
            
            // Generate download button for receipt responses
            let downloadButtonHtml = '';
            if (isReceiptResponse && result.success && isBinaryResponse) {
                const contentType = result.content_type || '';
                let fileExtension = 'pdf';
                let fileType = 'PDF';
                
                if (contentType.includes('zip') || contentType.includes('application/zip')) {
                    fileExtension = 'zip';
                    fileType = 'ZIP';
                } else if (contentType.includes('pdf') || contentType.includes('application/pdf')) {
                    fileExtension = 'pdf';
                    fileType = 'PDF';
                }
                
                const downloadId = `download-${result.test_id}-${Date.now()}`;
                // Store base64 data in a data attribute to avoid issues with special characters in onclick
                downloadButtonHtml = `
                    <div style="margin-top: 10px;">
                        <button 
                            id="${downloadId}"
                            data-base64="${result.response_data.replace(/"/g, '&quot;')}"
                            data-extension="${fileExtension}"
                            data-type="${fileType}"
                            onclick="downloadReceiptFileFromButton(this)"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;"
                        >
                            üì• Download ${fileType}
                        </button>
                    </div>
                `;
            }
            
            if (result.blocked) {
                return `
                    <div style="margin-top: 15px; padding: 12px; background: #ffe5e5; border-left: 4px solid #d50009; border-radius: 6px;">
                        <strong style="color: #d50009;">üõ°Ô∏è Production Safety Block:</strong>
                        <pre style="color: #d50009; font-weight: bold; margin-top: 5px;">${result.error}</pre>
                        ${requestBodyHtml}
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #d50009; border-radius: 4px;">
                            <strong>‚ÑπÔ∏è Allowed Production CIDs:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li><strong>4547</strong> - Test Account</li>
                                <li><strong>1995</strong> - Test Account</li>
                            </ul>
                            <p style="margin: 5px 0; font-size: 13px;">
                                Use one of these CID values in your test request body to run tests in production environments.
                            </p>
                        </div>
                    </div>
                `;
            } else if (result.success) {
                // For binary responses, don't show the raw data
                const responseDisplay = isBinaryResponse 
                    ? `<div style="margin-top: 5px; padding: 10px; background: #f3f4f6; border-radius: 4px; font-size: 11px; color: #6b7280;">
                        Binary file received (${result.content_type || 'unknown type'})
                    </div>`
                    : `<pre style="margin-top: 5px; background: white; padding: 10px; border-radius: 4px; font-size: 11px;">${JSON.stringify(result.response_data, null, 2)}</pre>`;
                
                return `
                    <div style="margin-top: 15px; padding: 12px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 6px;">
                        <strong style="color: #065f46;">‚úÖ Passed (${result.response_time_ms}ms) - Status: ${result.status_code}</strong>
                        ${requestBodyHtml}
                        <strong style="display: block; margin-top: 10px;">Response:</strong>
                        ${responseDisplay}
                        ${downloadButtonHtml}
                    </div>
                `;
            } else {
                return `
                    <div style="margin-top: 15px; padding: 12px; background: #fee2e2; border-left: 4px solid #ef4444; border-radius: 6px;">
                        <strong style="color: #991b1b;">‚ùå Failed - ${result.error || 'Status: ' + result.status_code}</strong>
                        ${requestBodyHtml}
                        <strong style="display: block; margin-top: 10px;">Response:</strong>
                        <pre style="margin-top: 5px; background: white; padding: 10px; border-radius: 4px; font-size: 11px;">${JSON.stringify(result.response_data || result.error, null, 2)}</pre>
                    </div>
                `;
            }
        }
        
        function downloadReceiptFileFromButton(button) {
            try {
                const base64Data = button.getAttribute('data-base64');
                const fileExtension = button.getAttribute('data-extension') || 'pdf';
                const fileType = button.getAttribute('data-type') || 'PDF';
                
                if (!base64Data) {
                    alert('No file data available');
                    return;
                }
                
                // Decode base64 data
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // Create blob
                const blob = new Blob([bytes], { 
                    type: fileExtension === 'pdf' ? 'application/pdf' : 'application/zip' 
                });
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `payment_receipt_${Date.now()}.${fileExtension}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Update button to show success
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Downloaded';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#667eea';
                }, 2000);
            } catch (error) {
                alert('Error downloading file: ' + error.message);
            }
        }

        async function runSingleTest(testId) {
            const card = document.getElementById(`test-${testId}`);
            const status = document.getElementById(`status-${testId}`);
            
            card.className = 'test-card running';
            status.className = 'test-status running';
            status.innerHTML = '<div class="spinner"></div> Running test...';
            
            // Check if there's a payment account IDs input for Delete Payment Account
            const paymentAccountIdsInput = document.getElementById(`payment-account-ids-${testId}`);
            const paymentAccountIds = paymentAccountIdsInput ? paymentAccountIdsInput.value.trim() : '';
            
            // Check if there's a scheduled payment IDs input for Delete Auto Payment
            const scheduledPaymentIdsInput = document.getElementById(`scheduled-payment-ids-${testId}`);
            const scheduledPaymentIds = scheduledPaymentIdsInput ? scheduledPaymentIdsInput.value.trim() : '';
            
            // Check if there are Add Auto Payment inputs
            const autoPaymentAccountIdInput = document.getElementById(`auto-payment-account-id-${testId}`);
            const autoPaymentAccountId = autoPaymentAccountIdInput ? autoPaymentAccountIdInput.value.trim() : '';
            const autoPaymentTypeIdInput = document.getElementById(`auto-payment-type-id-${testId}`);
            const autoPaymentTypeId = autoPaymentTypeIdInput ? autoPaymentTypeIdInput.value.trim() : '';
            
            // Check if there are Make Payment inputs
            const makePaymentAccountIdInput = document.getElementById(`make-payment-account-id-${testId}`);
            const makePaymentAccountId = makePaymentAccountIdInput ? makePaymentAccountIdInput.value.trim() : '';
            const makePaymentTypeIdInput = document.getElementById(`make-payment-type-id-${testId}`);
            const makePaymentTypeId = makePaymentTypeIdInput ? makePaymentTypeIdInput.value.trim() : '';
            
            // Check if there's a cancel payment IDs input for Cancel Payment
            const cancelPaymentIdsInput = document.getElementById(`cancel-payment-ids-${testId}`);
            const cancelPaymentIds = cancelPaymentIdsInput ? cancelPaymentIdsInput.value.trim() : '';
            
            // Check if there's a receipt payment IDs input for Get Payment Receipt
            const receiptPaymentIdsInput = document.getElementById(`receipt-payment-ids-${testId}`);
            const receiptPaymentIds = receiptPaymentIdsInput ? receiptPaymentIdsInput.value.trim() : '';
            
            // Check if there's a payment status ID input for Get Payment Status
            const paymentStatusIdInput = document.getElementById(`payment-status-id-${testId}`);
            const paymentStatusId = paymentStatusIdInput ? paymentStatusIdInput.value.trim() : '';
            
            try {
                const requestBody = {
                    environment: currentEnvironment
                };
                
                // Add payment account IDs if provided
                if (paymentAccountIds) {
                    requestBody.payment_account_ids = paymentAccountIds;
                }
                
                // Add scheduled payment IDs if provided
                if (scheduledPaymentIds) {
                    requestBody.scheduled_payment_ids = scheduledPaymentIds;
                }
                
                // Add auto payment configuration if provided
                if (autoPaymentAccountId || autoPaymentTypeId) {
                    requestBody.auto_payment_config = {};
                    if (autoPaymentAccountId) {
                        requestBody.auto_payment_config.payment_account_id = autoPaymentAccountId;
                    }
                    if (autoPaymentTypeId) {
                        requestBody.auto_payment_config.payment_type_id = autoPaymentTypeId;
                    }
                }
                
                // Add make payment configuration if provided
                if (makePaymentAccountId || makePaymentTypeId) {
                    requestBody.make_payment_config = {};
                    if (makePaymentAccountId) {
                        requestBody.make_payment_config.customer_payment_account_id = makePaymentAccountId;
                    }
                    if (makePaymentTypeId) {
                        requestBody.make_payment_config.payment_type_id = makePaymentTypeId;
                    }
                }
                
                // Add cancel payment IDs if provided
                if (cancelPaymentIds) {
                    requestBody.cancel_payment_ids = cancelPaymentIds;
                }
                
                // Add receipt payment IDs if provided
                if (receiptPaymentIds) {
                    requestBody.receipt_payment_ids = receiptPaymentIds;
                }
                
                // Add payment status ID if provided
                if (paymentStatusId) {
                    requestBody.payment_status_id = paymentStatusId;
                }
                
                const response = await fetch(`/api/run-test/${testId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const result = await response.json();
                
                const responseDiv = document.getElementById(`response-${testId}`);
                
                // Unified handling: always treat as array of results
                let resultsArray = [];
                if (result.has_multiple_scenarios && result.results) {
                    // Multiple scenarios
                    testResults[testId] = result;
                    resultsArray = result.results;
                } else {
                    // Single scenario - wrap in array for unified display
                    testResults[testId] = result;
                    resultsArray = [result];
                }
                
                // Calculate summary
                const passed = resultsArray.filter(r => r.success && !r.blocked).length;
                const failed = resultsArray.filter(r => !r.success && !r.blocked).length;
                const blocked = resultsArray.filter(r => r.blocked).length;
                const total = resultsArray.length;
                
                // Determine overall status
                if (blocked > 0) {
                    card.className = 'test-card blocked';
                    status.className = 'test-status blocked';
                    status.innerHTML = `üî¥ ${blocked} Blocked, ${passed} Passed, ${failed} Failed`;
                } else if (failed === 0 && total > 0) {
                    card.className = 'test-card passed';
                    status.className = 'test-status passed';
                    status.innerHTML = `‚úÖ All ${passed} scenario${passed !== 1 ? 's' : ''} passed`;
                } else if (passed === 0) {
                    card.className = 'test-card failed';
                    status.className = 'test-status failed';
                    status.innerHTML = `‚ùå All ${failed} scenario${failed !== 1 ? 's' : ''} failed`;
                } else {
                    card.className = 'test-card failed';
                    status.className = 'test-status failed';
                    status.innerHTML = `‚ö†Ô∏è ${passed} Passed, ${failed} Failed`;
                }
                
                // Render all scenario results in unified format
                let scenariosHtml = '<div style="margin-top: 15px;"><strong>Scenario Results:</strong>';
                resultsArray.forEach((scenarioResult, idx) => {
                    const scenarioName = scenarioResult.scenario_name || `Scenario ${idx + 1}`;
                    scenariosHtml += `<div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <strong style="font-size: 13px; color: #667eea;">${scenarioName}</strong>
                        ${renderSingleResult(scenarioResult, null)}
                    </div>`;
                });
                scenariosHtml += '</div>';
                
                if (responseDiv) {
                    responseDiv.innerHTML = scenariosHtml;
                }
                
                updateSummary();
            } catch (error) {
                card.className = 'test-card failed';
                status.className = 'test-status failed';
                status.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function runAllTests() {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running...';
            
            // Reset all cards (only if they exist in DOM - filter aware)
            testCases.forEach(tc => {
                const card = document.getElementById(`test-${tc.id}`);
                const status = document.getElementById(`status-${tc.id}`);
                
                // Only update if elements exist (rendered in current filter)
                if (card && status) {
                    card.className = 'test-card running';
                    status.className = 'test-status running';
                    status.innerHTML = '<div class="spinner"></div> Running test...';
                }
            });
            
            try {
                const response = await fetch('/api/run-all-tests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        environment: currentEnvironment
                    })
                });
                const data = await response.json();
                
                // Group results by test_id to handle multiple scenarios
                const resultsByTest = {};
                data.results.forEach(result => {
                    if (!resultsByTest[result.test_id]) {
                        resultsByTest[result.test_id] = [];
                    }
                    resultsByTest[result.test_id].push(result);
                });
                
                // Update each test card with results
                Object.keys(resultsByTest).forEach(testId => {
                    const results = resultsByTest[testId];
                    const card = document.getElementById(`test-${testId}`);
                    const status = document.getElementById(`status-${testId}`);
                    const responseDiv = document.getElementById(`response-${testId}`);
                    
                    // Store results (use first result for backward compatibility, or create grouped result)
                    if (results.length === 1) {
                        testResults[testId] = results[0];
                    } else {
                        // Multiple scenarios - create grouped result
                        const passed = results.filter(r => r.success && !r.blocked).length;
                        const failed = results.filter(r => !r.success && !r.blocked).length;
                        const blocked = results.filter(r => r.blocked).length;
                        testResults[testId] = {
                            test_id: testId,
                            test_name: results[0].test_name,
                            has_multiple_scenarios: true,
                            results: results,
                            summary: {
                                total: results.length,
                                passed: passed,
                                failed: failed,
                                blocked: blocked
                            }
                        };
                    }
                    
                    // Skip updating DOM if elements don't exist (filtered out)
                    if (!card || !status || !responseDiv) {
                        return;
                    }
                    
                    // Unified handling: always treat as array of results
                    const resultsArray = results;
                    const passed = resultsArray.filter(r => r.success && !r.blocked).length;
                    const failed = resultsArray.filter(r => !r.success && !r.blocked).length;
                    const blocked = resultsArray.filter(r => r.blocked).length;
                    const total = resultsArray.length;
                    
                    // Determine overall status
                    if (blocked > 0) {
                        card.className = 'test-card blocked';
                        status.className = 'test-status blocked';
                        status.innerHTML = `üî¥ ${blocked} Blocked, ${passed} Passed, ${failed} Failed`;
                    } else if (failed === 0 && total > 0) {
                        card.className = 'test-card passed';
                        status.className = 'test-status passed';
                        status.innerHTML = `‚úÖ All ${passed} scenario${passed !== 1 ? 's' : ''} passed`;
                    } else if (passed === 0) {
                        card.className = 'test-card failed';
                        status.className = 'test-status failed';
                        status.innerHTML = `‚ùå All ${failed} scenario${failed !== 1 ? 's' : ''} failed`;
                    } else {
                        card.className = 'test-card failed';
                        status.className = 'test-status failed';
                        status.innerHTML = `‚ö†Ô∏è ${passed} Passed, ${failed} Failed`;
                    }
                    
                    // Render all scenario results in unified format
                    let scenariosHtml = '<div style="margin-top: 15px;"><strong>Scenario Results:</strong>';
                    resultsArray.forEach((scenarioResult, idx) => {
                        const scenarioName = scenarioResult.scenario_name || `Scenario ${idx + 1}`;
                        scenariosHtml += `<div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <strong style="font-size: 13px; color: #667eea;">${scenarioName}</strong>
                            ${renderSingleResult(scenarioResult, null)}
                        </div>`;
                    });
                    scenariosHtml += '</div>';
                    responseDiv.innerHTML = scenariosHtml;
                });
                
                updateSummary();
                
            } catch (error) {
                alert('Error running tests: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ñ∂ Run All Tests';
            }
        }

        function updateSummary() {
            const results = Object.values(testResults);
            let blocked = 0;
            let passed = 0;
            let failed = 0;
            let totalTime = 0;
            let totalCount = 0;
            
            results.forEach(result => {
                if (result.has_multiple_scenarios && result.results) {
                    // Multiple scenarios - count each one
                    result.results.forEach(scenario => {
                        if (scenario.blocked) {
                            blocked++;
                        } else if (scenario.success) {
                            passed++;
                        } else {
                            failed++;
                        }
                        if (scenario.response_time_ms) {
                            totalTime += scenario.response_time_ms;
                            totalCount++;
                        }
                    });
                } else {
                    // Single scenario
                    if (result.blocked) {
                        blocked++;
                    } else if (result.success) {
                        passed++;
                    } else {
                        failed++;
                    }
                    if (result.response_time_ms) {
                        totalTime += result.response_time_ms;
                        totalCount++;
                    }
                }
            });
            
            const avgTime = totalCount > 0 ? Math.round(totalTime / totalCount) : 0;
            
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('blockedTests').textContent = blocked;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
            
            // Show/hide blocked summary card based on whether there are blocked tests
            const blockedCard = document.getElementById('blockedSummaryCard');
            if (blocked > 0) {
                blockedCard.style.display = 'block';
            } else {
                blockedCard.style.display = 'none';
            }
        }

        function clearResults() {
            testResults = {};
            updateSummary();
            renderTests();
            document.getElementById('passedTests').textContent = '0';
            document.getElementById('failedTests').textContent = '0';
            document.getElementById('blockedTests').textContent = '0';
            document.getElementById('avgTime').textContent = '0ms';
            document.getElementById('blockedSummaryCard').style.display = 'none';
        }

        function toggleDetails(testId) {
            const details = document.getElementById(`details-${testId}`);
            details.classList.toggle('show');
        }

        function filterTests(category) {
            currentFilter = category;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${category}"]`).classList.add('active');
            
            renderTests();
        }

        function downloadReport() {
            // Check if there are any test results
            const results = Object.values(testResults);
            if (results.length === 0) {
                alert('No test results to download. Please run some tests first!');
                return;
            }

            // Get environment name
            const envName = environments.find(e => e.id === currentEnvironment)?.name || currentEnvironment;
            
            // Format date as dd-mm-yyyy H:i:s
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const dateStr = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            
            // Helper function to escape CSV values (handles quotes, commas, newlines)
            const escapeCSV = (value) => {
                if (value == null) return '';
                const str = String(value);
                // Always wrap in quotes for better Excel formatting
                return '"' + str.replace(/"/g, '""') + '"';
            };
            
            // Calculate summary stats
            const blocked = results.filter(r => r.blocked).length;
            const passed = results.filter(r => r.success && !r.blocked).length;
            const failed = results.filter(r => !r.success && !r.blocked).length;
            const avgTime = results.length > 0 
                ? Math.round(results.reduce((sum, r) => sum + (r.response_time_ms || 0), 0) / results.length)
                : 0;
            
            // Prepare CSV data
            const csvRows = [];
            
            // Add report header section
            csvRows.push(`"API Test Report"`);
            csvRows.push(`"Environment:","${envName}"`);
            csvRows.push(`"Generated:","${dateStr}"`);
            csvRows.push(`"Total Tests:","${results.length}"`);
            csvRows.push(`"Passed:","${passed}"`);
            csvRows.push(`"Failed:","${failed}"`);
            csvRows.push(`"Blocked:","${blocked}"`);
            csvRows.push(`"Avg Response Time:","${avgTime}ms"`);
            csvRows.push(''); // Empty line for separation
            
            // Header row for test data
            csvRows.push([
                'API Name',
                'Environment',
                'Status Code',
                'Response Time',
                'Result',
                'Request',
                'Response'
            ].map(h => escapeCSV(h)).join(','));
            
            // Data rows
            results.forEach(result => {
                // Find the test case details
                const testCase = testCases.find(tc => tc.id === result.test_id);
                
                // Use scenario name if available, otherwise just test name
                let apiName = result.test_name || testCase?.name || 'Unknown';
                if (result.scenario_name) {
                    apiName += ` - ${result.scenario_name}`;
                }
                
                const statusCode = result.blocked ? 'BLOCKED' : (result.status_code || 'N/A');
                const responseTime = result.response_time_ms ? `${result.response_time_ms}ms` : 'N/A';
                const resultStatus = result.blocked ? 'üî¥ BLOCKED' : (result.success ? '‚úÖ PASSED' : '‚ùå FAILED');
                
                // Use request_body from result if available (for multiple scenarios), otherwise fall back to testCase.body
                const requestBody = result.request_body || testCase?.body || {};
                const requestStr = JSON.stringify(requestBody, null, 4);
                const responseStr = result.blocked 
                    ? result.error 
                    : JSON.stringify(result.response_data || result.error || {}, null, 4);
                
                const row = [
                    escapeCSV(apiName),
                    escapeCSV(envName),
                    escapeCSV(statusCode),
                    escapeCSV(responseTime),
                    escapeCSV(resultStatus),
                    escapeCSV(requestStr),
                    escapeCSV(responseStr)
                ].join(',');
                
                csvRows.push(row);
            });
            
            // Join all rows with newlines
            const csvContent = csvRows.join('\n');
            
            // Create blob with UTF-8 BOM for better Excel compatibility
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename
            const filename = `${envName} - ${dateStr}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`üì• Downloaded report: ${filename}`);
        }

        // Load environments and tests on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadEnvironments();
        });
    </script>
</body>
</html>

