<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Runner - External API Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        /* Environment-specific colors */
        .controls.env-dev {
            background: #508611;
        }

        .controls.env-prod {
            background: #d50009;
        }

        .controls.env-dev .btn-primary,
        .controls.env-prod .btn-primary {
            background: white;
            color: #333;
        }

        .controls.env-dev .btn-primary:hover,
        .controls.env-prod .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .controls.env-dev label,
        .controls.env-prod label {
            color: white !important;
        }

        .controls.env-dev .btn-secondary,
        .controls.env-prod .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
        }

        .controls.env-dev .btn-secondary:hover,
        .controls.env-prod .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .controls.env-dev .filter-btn,
        .controls.env-prod .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .controls.env-dev .filter-btn.active,
        .controls.env-prod .filter-btn.active {
            background: white;
            color: #333;
            border: 1px solid white;
        }

        .controls.env-dev .filter-btn:hover,
        .controls.env-prod .filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .controls.env-dev .filter-btn.active:hover,
        .controls.env-prod .filter-btn.active:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .summary-card .number {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-card .label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card.total .number { color: #667eea; }
        .summary-card.passed .number { color: #10b981; }
        .summary-card.failed .number { color: #ef4444; }
        .summary-card.time .number { font-size: 32px; }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        .test-card.running {
            border-left-color: #f59e0b;
            animation: pulse 2s ease-in-out infinite;
        }

        .test-card.passed {
            border-left-color: #10b981;
        }

        .test-card.failed {
            border-left-color: #ef4444;
        }

        .test-card.blocked {
            border-left-color: #d50009;
            background: #fff5f5;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .test-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .test-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-post { background: #dbeafe; color: #1e40af; }
        .badge-get { background: #d1fae5; color: #065f46; }
        .badge-put { background: #fef3c7; color: #92400e; }
        .badge-delete { background: #fee2e2; color: #991b1b; }

        .test-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }

        .test-category {
            display: inline-block;
            padding: 4px 10px;
            background: #f3f4f6;
            border-radius: 8px;
            font-size: 12px;
            color: #4b5563;
        }

        .test-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .test-status.pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        .test-status.running {
            background: #fef3c7;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status.passed {
            background: #d1fae5;
            color: #065f46;
        }

        .test-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .test-status.blocked {
            background: #ffe5e5;
            color: #d50009;
            font-weight: 700;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #92400e;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .test-details {
            margin-top: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .test-details.show {
            max-height: 500px;
            overflow-y: auto;
        }

        .test-details pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 11px;
        }

        .toggle-details {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            padding: 5px 0;
        }

        .toggle-details:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .no-tests {
            background: white;
            padding: 60px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .no-tests h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        .response-time {
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ API Test Runner</h1>
            <p>External API Testing Suite - Run individual tests or execute all tests at once</p>
        </div>

        <div class="controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <select id="envSelector" onchange="changeEnvironment()" style="padding: 10px 20px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: white; min-width: 250px;">
                    <option value="">Loading...</option>
                </select>
                <span id="envTypeBadge" style="padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: none;"></span>
            </div>
            
            <button class="btn btn-primary" onclick="runAllTests()" id="runAllBtn">
                ‚ñ∂ Run All Tests
            </button>
            <button class="btn btn-primary" onclick="clearResults()" id="clearBtn">
                üóëÔ∏è Clear
            </button>
            <button class="btn btn-primary" onclick="loadTestCases()">
                üîÑ Reload Tests
            </button>
            <button class="btn btn-primary" onclick="downloadReport()" id="downloadBtn">
                üì• Download
            </button>
            
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all" onclick="filterTests('all')">All</button>
                <button class="filter-btn" data-filter="Payment" onclick="filterTests('Payment')">Payment</button>
                <button class="filter-btn" data-filter="Payment Account" onclick="filterTests('Payment Account')">Payment Account</button>
                <button class="filter-btn" data-filter="Auto Payment" onclick="filterTests('Auto Payment')">Auto Payment</button>
                <button class="filter-btn" data-filter="Settings" onclick="filterTests('Settings')">Settings</button>
            </div>
        </div>

        <div class="summary">
            <div class="summary-card total">
                <div class="number" id="totalTests">0</div>
                <div class="label">Total Tests</div>
            </div>
            <div class="summary-card passed">
                <div class="number" id="passedTests">0</div>
                <div class="label">Passed</div>
            </div>
            <div class="summary-card failed">
                <div class="number" id="failedTests">0</div>
                <div class="label">Failed</div>
            </div>
            <div class="summary-card blocked" id="blockedSummaryCard" style="display: none;">
                <div class="number" id="blockedTests">0</div>
                <div class="label">üî¥ Blocked</div>
            </div>
            <div class="summary-card time">
                <div class="number" id="avgTime">0ms</div>
                <div class="label">Avg Response Time</div>
            </div>
        </div>

        <div class="loading" id="loading">Loading test cases...</div>
        
        <div class="test-grid" id="testGrid" style="display: none;"></div>
    </div>

    <script>
        let testCases = [];
        let testResults = {};
        let currentFilter = 'all';
        let environments = [];
        let currentEnvironment = 'capricorn-trunk';

        async function loadEnvironments() {
            try {
                const response = await fetch('/api/environments');
                const data = await response.json();
                
                environments = data.environments;
                currentEnvironment = data.default_environment;
                
                // Populate environment selector
                const selector = document.getElementById('envSelector');
                selector.innerHTML = '';
                
                environments.forEach(env => {
                    const option = document.createElement('option');
                    option.value = env.id;
                    option.textContent = `${env.name}`;
                    if (env.id === currentEnvironment) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
                
                // Set initial environment color
                updateEnvironmentColor();
                
                // Load test cases for default environment
                await loadTestCases();
            } catch (error) {
                console.error('Error loading environments:', error);
                document.getElementById('loading').textContent = 'Error loading environments: ' + error.message;
            }
        }

        async function changeEnvironment() {
            const selector = document.getElementById('envSelector');
            currentEnvironment = selector.value;
            
            // Update controls div color based on environment
            updateEnvironmentColor();
            
            // Clear results when switching environments
            testResults = {};
            updateSummary();
            
            // Reload test cases for new environment
            await loadTestCases();
        }

        function updateEnvironmentColor() {
            const controlsDiv = document.querySelector('.controls');
            const badge = document.getElementById('envTypeBadge');
            
            // Define environment colors
            const prodEnvironments = ['rapid-prod', 'standard-prod'];
            const devEnvironments = ['capricorn-trunk', 'rapid-stage', 'standard-stage', 'external-local'];
            
            // Remove existing environment classes
            controlsDiv.classList.remove('env-dev', 'env-prod');
            
            // Add appropriate class based on current environment
            if (prodEnvironments.includes(currentEnvironment)) {
                controlsDiv.classList.add('env-prod');
                badge.textContent = 'üî¥ PRODUCTION';
                badge.style.background = 'rgba(255, 255, 255, 0.3)';
                badge.style.color = 'white';
                badge.style.border = '2px solid white';
                badge.style.display = 'inline-block';
            } else if (devEnvironments.includes(currentEnvironment)) {
                controlsDiv.classList.add('env-dev');
                const envName = currentEnvironment.includes('stage') ? 'STAGING' : 'DEVELOPMENT';
                badge.textContent = 'üü¢ ' + envName;
                badge.style.background = 'rgba(255, 255, 255, 0.3)';
                badge.style.color = 'white';
                badge.style.border = '2px solid white';
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        async function loadTestCases() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('testGrid').style.display = 'none';
                
                const response = await fetch(`/api/test-cases?environment=${currentEnvironment}`);
                const data = await response.json();
                
                testCases = data.test_cases;
                testResults = {};
                
                document.getElementById('totalTests').textContent = testCases.length;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('testGrid').style.display = 'grid';
                
                renderTests();
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading tests: ' + error.message;
            }
        }

        function renderTests() {
            const grid = document.getElementById('testGrid');
            grid.innerHTML = '';
            
            const filtered = currentFilter === 'all' 
                ? testCases 
                : testCases.filter(tc => tc.category === currentFilter);
            
            filtered.forEach(testCase => {
                const card = createTestCard(testCase);
                grid.appendChild(card);
            });
        }

        function createTestCard(testCase) {
            const card = document.createElement('div');
            card.className = 'test-card';
            card.id = `test-${testCase.id}`;
            
            const methodClass = `badge-${testCase.method.toLowerCase()}`;
            
            card.innerHTML = `
                <div class="test-header">
                    <div class="test-title">${testCase.name}</div>
                    <span class="test-badge ${methodClass}">${testCase.method}</span>
                </div>
                <div class="test-meta">
                    <span class="test-category">${testCase.category}</span>
                </div>
                <div class="test-status pending" id="status-${testCase.id}">
                    Ready to run
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="runSingleTest('${testCase.id}')">
                    ‚ñ∂ Run Test
                </button>
                <button class="toggle-details" onclick="toggleDetails('${testCase.id}')">Show Details</button>
                <div class="test-details" id="details-${testCase.id}">
                    <strong>Endpoint:</strong> ${testCase.endpoint}<br>
                    <strong>Request Body:</strong>
                    <pre>${JSON.stringify(testCase.body, null, 2)}</pre>
                    <div id="response-${testCase.id}"></div>
                </div>
            `;
            
            return card;
        }

        async function runSingleTest(testId) {
            const card = document.getElementById(`test-${testId}`);
            const status = document.getElementById(`status-${testId}`);
            
            card.className = 'test-card running';
            status.className = 'test-status running';
            status.innerHTML = '<div class="spinner"></div> Running test...';
            
            try {
                const response = await fetch(`/api/run-test/${testId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        environment: currentEnvironment
                    })
                });
                const result = await response.json();
                
                testResults[testId] = result;
                
                if (result.blocked) {
                    // Production safety block
                    card.className = 'test-card blocked';
                    status.className = 'test-status blocked';
                    status.innerHTML = `üî¥ BLOCKED - ${result.error}`;
                    
                    const responseDiv = document.getElementById(`response-${testId}`);
                    responseDiv.innerHTML = `
                        <strong style="color: #d50009;">üõ°Ô∏è Production Safety Block:</strong>
                        <pre style="color: #d50009; font-weight: bold;">${result.error}</pre>
                        <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #d50009; border-radius: 4px;">
                            <strong>‚ÑπÔ∏è Allowed Production CIDs:</strong>
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li><strong>4547</strong> - Test Account</li>
                                <li><strong>1995</strong> - Test Account</li>
                            </ul>
                            <p style="margin: 5px 0; font-size: 13px;">
                                Use one of these CID values in your test request body to run tests in production environments.
                            </p>
                        </div>
                    `;
                } else if (result.success) {
                    card.className = 'test-card passed';
                    status.className = 'test-status passed';
                    status.innerHTML = `‚úÖ Passed (${result.response_time_ms}ms) - Status: ${result.status_code}`;
                    
                    const responseDiv = document.getElementById(`response-${testId}`);
                    if (responseDiv) {
                        responseDiv.innerHTML = `
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(result.response_data, null, 2)}</pre>
                        `;
                    }
                } else {
                    card.className = 'test-card failed';
                    status.className = 'test-status failed';
                    status.innerHTML = `‚ùå Failed - ${result.error || 'Status: ' + result.status_code}`;
                    
                    const responseDiv = document.getElementById(`response-${testId}`);
                    if (responseDiv) {
                        responseDiv.innerHTML = `
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(result.response_data || result.error, null, 2)}</pre>
                        `;
                    }
                }
                
                updateSummary();
            } catch (error) {
                card.className = 'test-card failed';
                status.className = 'test-status failed';
                status.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        async function runAllTests() {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running...';
            
            // Reset all cards (only if they exist in DOM - filter aware)
            testCases.forEach(tc => {
                const card = document.getElementById(`test-${tc.id}`);
                const status = document.getElementById(`status-${tc.id}`);
                
                // Only update if elements exist (rendered in current filter)
                if (card && status) {
                    card.className = 'test-card running';
                    status.className = 'test-status running';
                    status.innerHTML = '<div class="spinner"></div> Running test...';
                }
            });
            
            try {
                const response = await fetch('/api/run-all-tests', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        environment: currentEnvironment
                    })
                });
                const data = await response.json();
                
                // Update each test card with results
                data.results.forEach(result => {
                    const card = document.getElementById(`test-${result.test_id}`);
                    const status = document.getElementById(`status-${result.test_id}`);
                    const responseDiv = document.getElementById(`response-${result.test_id}`);
                    
                    // Always store results (even for filtered out tests)
                    testResults[result.test_id] = result;
                    
                    // Skip updating DOM if elements don't exist (filtered out)
                    if (!card || !status || !responseDiv) {
                        return;
                    }
                    
                    if (result.blocked) {
                        // Production safety block
                        card.className = 'test-card blocked';
                        status.className = 'test-status blocked';
                        status.innerHTML = `üî¥ BLOCKED - ${result.error}`;
                        
                        responseDiv.innerHTML = `
                            <strong style="color: #d50009;">üõ°Ô∏è Production Safety Block:</strong>
                            <pre style="color: #d50009; font-weight: bold;">${result.error}</pre>
                            <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-left: 4px solid #d50009; border-radius: 4px;">
                                <strong>‚ÑπÔ∏è Allowed Production CIDs:</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    <li><strong>4547</strong> - Test Account</li>
                                    <li><strong>1995</strong> - Test Account</li>
                                </ul>
                                <p style="margin: 5px 0; font-size: 13px;">
                                    Use one of these CID values in your test request body to run tests in production environments.
                                </p>
                            </div>
                        `;
                    } else if (result.success) {
                        card.className = 'test-card passed';
                        status.className = 'test-status passed';
                        status.innerHTML = `‚úÖ Passed (${result.response_time_ms}ms) - Status: ${result.status_code}`;
                        
                        responseDiv.innerHTML = `
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(result.response_data, null, 2)}</pre>
                        `;
                    } else {
                        card.className = 'test-card failed';
                        status.className = 'test-status failed';
                        status.innerHTML = `‚ùå Failed - ${result.error || 'Status: ' + result.status_code}`;
                        
                        responseDiv.innerHTML = `
                            <strong>Response:</strong>
                            <pre>${JSON.stringify(result.response_data || result.error, null, 2)}</pre>
                        `;
                    }
                });
                
                updateSummary();
                
            } catch (error) {
                alert('Error running tests: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ñ∂ Run All Tests';
            }
        }

        function updateSummary() {
            const results = Object.values(testResults);
            const blocked = results.filter(r => r.blocked).length;
            const passed = results.filter(r => r.success && !r.blocked).length;
            const failed = results.filter(r => !r.success && !r.blocked).length;
            const avgTime = results.length > 0 
                ? Math.round(results.reduce((sum, r) => sum + (r.response_time_ms || 0), 0) / results.length)
                : 0;
            
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('blockedTests').textContent = blocked;
            document.getElementById('avgTime').textContent = avgTime + 'ms';
            
            // Show/hide blocked summary card based on whether there are blocked tests
            const blockedCard = document.getElementById('blockedSummaryCard');
            if (blocked > 0) {
                blockedCard.style.display = 'block';
            } else {
                blockedCard.style.display = 'none';
            }
        }

        function clearResults() {
            testResults = {};
            updateSummary();
            renderTests();
            document.getElementById('passedTests').textContent = '0';
            document.getElementById('failedTests').textContent = '0';
            document.getElementById('blockedTests').textContent = '0';
            document.getElementById('avgTime').textContent = '0ms';
            document.getElementById('blockedSummaryCard').style.display = 'none';
        }

        function toggleDetails(testId) {
            const details = document.getElementById(`details-${testId}`);
            details.classList.toggle('show');
        }

        function filterTests(category) {
            currentFilter = category;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${category}"]`).classList.add('active');
            
            renderTests();
        }

        function downloadReport() {
            // Check if there are any test results
            const results = Object.values(testResults);
            if (results.length === 0) {
                alert('No test results to download. Please run some tests first!');
                return;
            }

            // Get environment name
            const envName = environments.find(e => e.id === currentEnvironment)?.name || currentEnvironment;
            
            // Format date as dd-mm-yyyy H:i:s
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const dateStr = `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
            
            // Helper function to escape CSV values (handles quotes, commas, newlines)
            const escapeCSV = (value) => {
                if (value == null) return '';
                const str = String(value);
                // Always wrap in quotes for better Excel formatting
                return '"' + str.replace(/"/g, '""') + '"';
            };
            
            // Calculate summary stats
            const blocked = results.filter(r => r.blocked).length;
            const passed = results.filter(r => r.success && !r.blocked).length;
            const failed = results.filter(r => !r.success && !r.blocked).length;
            const avgTime = results.length > 0 
                ? Math.round(results.reduce((sum, r) => sum + (r.response_time_ms || 0), 0) / results.length)
                : 0;
            
            // Prepare CSV data
            const csvRows = [];
            
            // Add report header section
            csvRows.push(`"API Test Report"`);
            csvRows.push(`"Environment:","${envName}"`);
            csvRows.push(`"Generated:","${dateStr}"`);
            csvRows.push(`"Total Tests:","${results.length}"`);
            csvRows.push(`"Passed:","${passed}"`);
            csvRows.push(`"Failed:","${failed}"`);
            csvRows.push(`"Blocked:","${blocked}"`);
            csvRows.push(`"Avg Response Time:","${avgTime}ms"`);
            csvRows.push(''); // Empty line for separation
            
            // Header row for test data
            csvRows.push([
                'API Name',
                'Environment',
                'Status Code',
                'Response Time',
                'Result',
                'Request',
                'Response'
            ].map(h => escapeCSV(h)).join(','));
            
            // Data rows
            results.forEach(result => {
                // Find the test case details
                const testCase = testCases.find(tc => tc.id === result.test_id);
                
                const apiName = result.test_name || testCase?.name || 'Unknown';
                const statusCode = result.blocked ? 'BLOCKED' : (result.status_code || 'N/A');
                const responseTime = result.response_time_ms ? `${result.response_time_ms}ms` : 'N/A';
                const resultStatus = result.blocked ? 'üî¥ BLOCKED' : (result.success ? '‚úÖ PASSED' : '‚ùå FAILED');
                
                // Format JSON with proper indentation (4 spaces)
                const requestStr = JSON.stringify(testCase?.body || {}, null, 4);
                const responseStr = result.blocked 
                    ? result.error 
                    : JSON.stringify(result.response_data || result.error || {}, null, 4);
                
                const row = [
                    escapeCSV(apiName),
                    escapeCSV(envName),
                    escapeCSV(statusCode),
                    escapeCSV(responseTime),
                    escapeCSV(resultStatus),
                    escapeCSV(requestStr),
                    escapeCSV(responseStr)
                ].join(',');
                
                csvRows.push(row);
            });
            
            // Join all rows with newlines
            const csvContent = csvRows.join('\n');
            
            // Create blob with UTF-8 BOM for better Excel compatibility
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename
            const filename = `${envName} - ${dateStr}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`üì• Downloaded report: ${filename}`);
        }

        // Load environments and tests on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadEnvironments();
        });
    </script>
</body>
</html>

